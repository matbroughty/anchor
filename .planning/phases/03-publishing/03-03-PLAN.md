---
phase: 03-publishing
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - app/(protected)/dashboard/DashboardClient.tsx
  - app/components/PublishToggle.tsx
autonomous: false

must_haves:
  truths:
    - "User can publish their page from the dashboard"
    - "User can unpublish their page from the dashboard"
    - "Dashboard shows current publish status"
    - "Published state shows link to public page"
  artifacts:
    - path: "app/components/PublishToggle.tsx"
      provides: "Publish/unpublish toggle component"
    - path: "app/(protected)/dashboard/DashboardClient.tsx"
      provides: "Updated dashboard with publish controls"
  key_links:
    - from: "app/components/PublishToggle.tsx"
      to: "app/actions/publish.ts"
      via: "server action calls"
      pattern: "(publishPage|unpublishPage)\\(\\)"
---

<objective>
Add publish/unpublish controls to the dashboard so users can control their page visibility.

Purpose: Users need a way to toggle their page between published and unpublished states. The dashboard already handles all content management, so this adds the final publishing controls.

Output:
- PublishToggle component with publish/unpublish button and status indicator
- Dashboard integration showing current status and link to public page
- Human verification of the complete publish flow
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-publishing/03-RESEARCH.md

# Publish actions from Plan 01
@app/actions/publish.ts

# Existing dashboard to integrate with
@app/(protected)/dashboard/page.tsx
@app/(protected)/dashboard/DashboardClient.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PublishToggle component</name>
  <files>app/components/PublishToggle.tsx</files>
  <action>
Create a client component at app/components/PublishToggle.tsx:

```typescript
'use client'

type PublishToggleProps = {
  isPublished: boolean
  handle: string
  onStatusChange: (newStatus: boolean) => void
}
```

Component behavior:
1. Show current status: "Published" or "Unpublished" with visual indicator (e.g., green/gray dot)
2. If published, show link to public page: anchor.band/{handle}
3. Toggle button: "Publish" when unpublished, "Unpublish" when published
4. Loading state while action is in progress
5. Call publishPage() or unpublishPage() server action on click
6. Call onStatusChange(newStatus) after successful action to update parent state
7. Show error toast/message if action fails (use existing toast pattern if available, otherwise inline error)

Styling:
- Clean, minimal design matching dashboard aesthetic
- Clear visual distinction between published/unpublished states
- Loading spinner or disabled state during action
- Link opens in new tab (target="_blank")

Import publishPage, unpublishPage from @/app/actions/publish.
  </action>
  <verify>Component renders, TypeScript compiles, no errors</verify>
  <done>PublishToggle component shows status, handles publish/unpublish actions, shows link when published</done>
</task>

<task type="auto">
  <name>Task 2: Integrate PublishToggle into dashboard</name>
  <files>app/(protected)/dashboard/page.tsx, app/(protected)/dashboard/DashboardClient.tsx</files>
  <action>
Update the dashboard to include publish controls:

1. In dashboard page.tsx (server component):
   - Query user's current isPublic status from DynamoDB
   - Query user's handle
   - Pass isPublished and handle to DashboardClient as new props

2. In DashboardClient.tsx (client component):
   - Accept new props: isPublished (boolean), handle (string)
   - Add state for publish status: const [published, setPublished] = useState(isPublished)
   - Add PublishToggle component at top of dashboard (before content sections)
   - Pass published, handle, and setPublished as onStatusChange

Position the PublishToggle prominently at the top of the dashboard, perhaps in a card/section that says "Your Page" with the toggle and link.

The publish section should be visible even if user hasn't connected Spotify yet (they just can't publish without content).
  </action>
  <verify>`npm run build` succeeds, dashboard loads without errors</verify>
  <done>Dashboard shows PublishToggle with current status, users can publish/unpublish from dashboard</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete publishing flow:
1. Data layer for public profiles (Plan 01)
2. Public page at /[handle] with OG metadata (Plan 02)
3. Publish/unpublish controls in dashboard (this plan)
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Sign in and go to /dashboard
3. Verify PublishToggle shows "Unpublished" status
4. Click "Publish" button
5. Verify status changes to "Published" with link to /your-handle
6. Click the link to visit public page
7. Verify public page shows:
   - Display name
   - Bio
   - Top artists (circular images)
   - Albums with captions
   - Top tracks
8. Check mobile responsiveness (resize browser or use devtools)
9. Unpublish the page from dashboard
10. Visit /your-handle again - should show 404
11. Optional: Test OG metadata with https://developers.facebook.com/tools/debug/ or similar
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds
2. Dashboard shows publish controls
3. Users can toggle publish status
4. Published pages visible at /handle
5. Unpublished pages show 404
6. Mobile responsive layout works
</verification>

<success_criteria>
- Dashboard displays current publish status
- User can publish page with one click
- User can unpublish page with one click
- Published status shows link to public page
- Complete flow verified by human tester
</success_criteria>

<output>
After completion, create `.planning/phases/03-publishing/03-03-SUMMARY.md`
</output>
