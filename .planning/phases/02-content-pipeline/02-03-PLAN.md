---
phase: 02-content-pipeline
plan: 03
type: execute
wave: 2
depends_on: [02-01, 02-02]
files_modified:
  - app/(protected)/dashboard/page.tsx
  - app/(protected)/dashboard/DashboardClient.tsx
  - app/components/MusicDataSection.tsx
  - app/components/BioEditor.tsx
  - app/components/AlbumCaptions.tsx
  - app/components/RefreshButton.tsx
  - app/actions/content-edit.ts
autonomous: false

must_haves:
  truths:
    - "User can view their top artists, albums, and tracks on dashboard"
    - "User can edit their bio text directly"
    - "User can edit album caption text directly"
    - "User can click regenerate to get new AI bio"
    - "User can click regenerate on individual album captions"
    - "User can refresh Spotify data with visible cooldown status"
    - "Regenerate button shows loading state during generation"
  artifacts:
    - path: "app/(protected)/dashboard/page.tsx"
      provides: "Dashboard page with music data and content editing"
      min_lines: 20
    - path: "app/(protected)/dashboard/DashboardClient.tsx"
      provides: "Client component for interactive dashboard"
      min_lines: 50
    - path: "app/components/BioEditor.tsx"
      provides: "Bio display with edit and regenerate controls"
      exports: ["BioEditor"]
    - path: "app/components/AlbumCaptions.tsx"
      provides: "Album grid with caption editing"
      exports: ["AlbumCaptions"]
    - path: "app/components/RefreshButton.tsx"
      provides: "Spotify refresh button with cooldown display"
      exports: ["RefreshButton"]
    - path: "app/actions/content-edit.ts"
      provides: "Server actions for manual content editing"
      exports: ["updateBio", "updateCaption"]
  key_links:
    - from: "app/(protected)/dashboard/DashboardClient.tsx"
      to: "app/actions/ai-content.ts"
      via: "regenerateBio, regenerateCaption calls"
      pattern: "regenerateBio|regenerateCaption"
    - from: "app/(protected)/dashboard/DashboardClient.tsx"
      to: "app/actions/spotify.ts"
      via: "refreshSpotifyData call"
      pattern: "refreshSpotifyData"
    - from: "app/components/BioEditor.tsx"
      to: "app/actions/content-edit.ts"
      via: "updateBio call"
      pattern: "updateBio"

user_setup:
  - service: aws-bedrock
    why: "AI content generation requires Bedrock access"
    env_vars:
      - name: AWS_ACCESS_KEY_ID
        source: "IAM user credentials with Bedrock access"
      - name: AWS_SECRET_ACCESS_KEY
        source: "IAM user credentials"
      - name: AWS_REGION
        source: "Region where Bedrock Claude is available (us-east-1 recommended)"
    dashboard_config:
      - task: "Enable Claude model access in Bedrock console"
        location: "AWS Console -> Bedrock -> Model access -> Request access to Claude 3 Haiku"
---

<objective>
Create the dashboard UI where users view their music data, edit AI-generated content, regenerate bios/captions, and manually refresh Spotify data.

Purpose: This is the content management interface - the last step before publishing. Users see their music data, review AI-generated text, make edits, and regenerate content until satisfied.

Output: Dashboard page with music data display, inline bio/caption editing, regenerate buttons with loading states, and Spotify refresh with cooldown indicator.
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# References prior plans in this phase
@types/music.ts
@types/content.ts
@app/actions/spotify.ts
@app/actions/ai-content.ts

# Existing UI patterns from Phase 1
@app/(protected)/layout.tsx
@app/(protected)/profile/page.tsx
@app/components/HandleInput.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content edit server actions</name>
  <files>app/actions/content-edit.ts</files>
  <action>
Create Server Actions for manual content editing:

**app/actions/content-edit.ts:**
```typescript
'use server'

import { auth } from '@/auth'
import { revalidatePath } from 'next/cache'
import { getBio, putBio, getCaption, putCaption } from '@/lib/dynamodb/content'
import type { Bio, Caption } from '@/types/content'
```

Functions:

`updateBio(newText: string): Promise<{ bio: Bio | null, error?: string }>`
- Validate: text must be 1-500 characters
- Get session, verify authenticated
- Get existing bio with getBio
- Create updated Bio object:
  - If existing bio: keep generatedAt, add editedAt: Date.now()
  - If no existing bio: set generatedAt: Date.now() and editedAt: Date.now()
- Save with putBio
- Revalidate '/dashboard' and '/profile'
- Return { bio: updatedBio }

`updateCaption(albumId: string, newText: string): Promise<{ caption: Caption | null, error?: string }>`
- Validate: albumId required, text 1-150 characters
- Get session, verify authenticated
- Get existing caption
- Create updated Caption object with editedAt timestamp
- Save with putCaption
- Revalidate paths
- Return { caption }

Both functions:
- Wrap in try/catch, return { error: message } on failure
- Preserve generatedAt timestamp (important for "revert to AI" feature later)
- Set editedAt to indicate manual editing
  </action>
  <verify>
TypeScript compiles:
```bash
npx tsc --noEmit
```
  </verify>
  <done>
- updateBio validates length and saves with editedAt timestamp
- updateCaption validates and saves caption edits
- Both preserve original generatedAt timestamp
- Proper error handling with typed responses
  </done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard page and music data components</name>
  <files>app/(protected)/dashboard/page.tsx, app/(protected)/dashboard/DashboardClient.tsx, app/components/MusicDataSection.tsx, app/components/RefreshButton.tsx</files>
  <action>
Create the dashboard page structure:

**app/(protected)/dashboard/page.tsx:**
Server component that fetches data and renders client component:
```typescript
import { auth } from '@/auth'
import { redirect } from 'next/navigation'
import { getMusicData } from '@/lib/dynamodb/music-data'
import { getContent } from '@/lib/dynamodb/content'
import { DashboardClient } from './DashboardClient'

export default async function DashboardPage() {
  const session = await auth()
  if (!session?.user?.id) redirect('/signin')

  const [musicData, contentData] = await Promise.all([
    getMusicData(session.user.id),
    getContent(session.user.id)
  ])

  return <DashboardClient
    initialMusicData={musicData}
    initialContent={contentData}
    userId={session.user.id}
  />
}
```

**app/(protected)/dashboard/DashboardClient.tsx:**
Client component managing state and interactions:
```typescript
'use client'

import { useState, useTransition } from 'react'
import { MusicDataSection } from '@/app/components/MusicDataSection'
import { BioEditor } from '@/app/components/BioEditor'
import { AlbumCaptions } from '@/app/components/AlbumCaptions'
import { RefreshButton } from '@/app/components/RefreshButton'
import { refreshSpotifyData } from '@/app/actions/spotify'
import { generateBio, generateAlbumCaptions } from '@/app/actions/ai-content'
import type { MusicData } from '@/types/music'
import type { ContentData } from '@/types/content'
```

State:
- musicData, content (from props, updated on refresh/generation)
- isPending (useTransition for non-blocking updates)
- cooldownRemaining (shown when refresh blocked)

Sections:
1. Header with "Your Music Profile" title
2. RefreshButton with cooldown state
3. MusicDataSection showing artists/tracks (if data exists)
4. BioEditor (if data exists)
5. AlbumCaptions grid (if data exists)
6. "Connect Spotify first" message if no data

**app/components/MusicDataSection.tsx:**
Display artists and tracks:
- Artists: Horizontal scroll of circular images with names
- Tracks: Simple list with track name and artist
- Clean, minimal styling with Tailwind
- Mobile responsive (stack on small screens)

**app/components/RefreshButton.tsx:**
Refresh button with cooldown:
```typescript
'use client'

import { useState, useTransition } from 'react'
import { refreshSpotifyData } from '@/app/actions/spotify'

interface RefreshButtonProps {
  onRefresh: (data: MusicData) => void
  cooldownRemaining?: number
}
```
- Show "Refresh from Spotify" when available
- Show "Next refresh in Xh Xm" when on cooldown
- Disabled state with loading spinner during refresh
- Call onRefresh callback with new data on success
  </action>
  <verify>
Dev server starts and page renders:
```bash
npm run dev
# Visit http://localhost:3000/dashboard
```
  </verify>
  <done>
- Dashboard page fetches data server-side
- DashboardClient manages interactive state
- MusicDataSection displays artists and tracks
- RefreshButton shows cooldown status
- Responsive layout with Tailwind
  </done>
</task>

<task type="auto">
  <name>Task 3: Create bio and caption editing components</name>
  <files>app/components/BioEditor.tsx, app/components/AlbumCaptions.tsx</files>
  <action>
Create content editing components:

**app/components/BioEditor.tsx:**
```typescript
'use client'

import { useState, useTransition } from 'react'
import { updateBio } from '@/app/actions/content-edit'
import { regenerateBio } from '@/app/actions/ai-content'
import type { Bio } from '@/types/content'

interface BioEditorProps {
  bio: Bio | null
  onUpdate: (bio: Bio) => void
  disabled?: boolean
}
```

Features:
- Display bio text (or "No bio generated yet" placeholder)
- Edit mode: textarea appears on "Edit" button click
- Save/Cancel buttons in edit mode
- Character count (max 500)
- "Regenerate" button with loading state
- Optimistic UI: show "Generating..." text while regenerating
- Call updateBio on save, regenerateBio on regenerate
- Show subtle "Edited" badge if bio.editedAt exists

**app/components/AlbumCaptions.tsx:**
```typescript
'use client'

import { useState, useTransition } from 'react'
import { updateCaption } from '@/app/actions/content-edit'
import { regenerateCaption } from '@/app/actions/ai-content'
import type { Album } from '@/types/music'
import type { Caption } from '@/types/content'

interface AlbumCaptionsProps {
  albums: Album[]
  captions: Caption[]
  onCaptionUpdate: (caption: Caption) => void
  disabled?: boolean
}
```

Layout:
- Grid of albums (3 columns on desktop, 2 on tablet, 1 on mobile)
- Each album card shows:
  - Album artwork (square image)
  - Album name and artist
  - Caption text (or "No caption" placeholder)
  - Edit/Regenerate buttons (appear on hover or always on mobile)

Edit mode for each caption:
- Small textarea (max 150 chars)
- Save/Cancel buttons
- Regenerate button specific to that album

Styling:
- Subtle borders, minimal aesthetic
- Loading states on individual regenerate buttons
- Hover effects for desktop
  </action>
  <verify>
All components render and TypeScript compiles:
```bash
npx tsc --noEmit && npm run dev
```
  </verify>
  <done>
- BioEditor allows viewing, editing, and regenerating bio
- AlbumCaptions displays grid with edit controls per album
- Character limits enforced (500 for bio, 150 for captions)
- Loading states for regeneration
- Edit mode toggles cleanly
- Responsive grid layout
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete content management dashboard with:
- Music data display (artists, albums, tracks)
- Bio editing and regeneration
- Album caption editing and regeneration
- Spotify data refresh with cooldown
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/dashboard
3. If not signed in, you'll be redirected to /signin
4. Verify UI structure:
   - Header shows "Your Music Profile"
   - Refresh button is visible (may show cooldown or "Connect Spotify" state)
   - Sections for bio and albums are present (may show placeholders if no data)
5. Check responsive layout:
   - Resize browser window
   - Album grid should adjust columns
   - Layout should remain readable on mobile widths

**Note:** Full functionality (actual Spotify data, AI generation) requires external services configured. This checkpoint verifies UI structure and navigation.
  </how-to-verify>
  <resume-signal>Type "approved" to confirm UI structure, or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
After all tasks:

1. Type checking passes:
```bash
npx tsc --noEmit
```

2. Dashboard page accessible:
```bash
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/dashboard
# Should redirect (302) to /signin if not authenticated
```

3. All components exist:
```bash
ls -la app/(protected)/dashboard/ app/components/BioEditor.tsx app/components/AlbumCaptions.tsx app/components/RefreshButton.tsx
```

4. Server actions properly marked:
```bash
grep "'use server'" app/actions/content-edit.ts
```
</verification>

<success_criteria>
- Dashboard page at /dashboard renders with server-side data fetching
- MusicDataSection displays artists (circular images) and tracks
- BioEditor supports view, edit, save, and regenerate flows
- AlbumCaptions displays album grid with per-album edit/regenerate
- RefreshButton shows cooldown status or allows refresh
- All forms have character limits and validation
- Loading states appear during async operations
- Responsive layout works on mobile and desktop
- updateBio and updateCaption server actions preserve timestamps
</success_criteria>

<output>
After completion, create `.planning/phases/02-content-pipeline/02-03-SUMMARY.md`
</output>
