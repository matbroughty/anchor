---
phase: 01-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-02"]
files_modified:
  - lib/handle.ts
  - app/api/profile/handle/route.ts
  - app/api/profile/route.ts
  - app/(protected)/profile/page.tsx
  - app/(protected)/profile/claim-handle/page.tsx
  - app/(protected)/layout.tsx
  - app/components/ProfileForm.tsx
  - app/components/HandleInput.tsx
autonomous: false

must_haves:
  truths:
    - "User can claim a unique handle that no one else has"
    - "Handle appears in URL format (anchor.band/handle conceptually)"
    - "User can set and update display name"
    - "User cannot claim an already-taken handle"
    - "Profile changes persist across sessions"
  artifacts:
    - path: "lib/handle.ts"
      provides: "Handle validation and claiming"
      exports: ["validateHandle", "claimHandle", "isHandleAvailable"]
    - path: "app/api/profile/handle/route.ts"
      provides: "Handle claiming API"
      exports: ["POST"]
    - path: "app/api/profile/route.ts"
      provides: "Profile CRUD API"
      exports: ["GET", "PATCH"]
    - path: "app/(protected)/profile/page.tsx"
      provides: "Profile management page"
      min_lines: 50
    - path: "app/components/HandleInput.tsx"
      provides: "Handle input with availability check"
      min_lines: 30
  key_links:
    - from: "lib/handle.ts"
      to: "lib/dynamodb.ts"
      via: "TransactWriteCommand for atomic claim"
      pattern: "TransactWriteCommand"
    - from: "app/api/profile/handle/route.ts"
      to: "lib/handle.ts"
      via: "claimHandle import"
      pattern: "claimHandle"
    - from: "app/(protected)/profile/page.tsx"
      to: "/api/profile"
      via: "fetch for profile data"
      pattern: "fetch.*api/profile"
---

<objective>
Implement unique handle claiming and profile management system.

Purpose: Enable users to claim their unique anchor.band/handle URL and manage their profile information (display name, etc.). Handles must be unique and validated to prevent conflicts.

Output: Working profile page where authenticated users can claim handles and edit their display name, with transaction-based uniqueness enforcement.
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
@.planning/phases/01-foundation/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Handle Validation and Claiming Logic</name>
  <files>
    lib/handle.ts
    app/api/profile/handle/route.ts
    app/api/profile/route.ts
  </files>
  <action>
Create handle validation, uniqueness enforcement, and profile APIs:

1. Create `lib/handle.ts` with handle utilities:

   **Validation rules** (from RESEARCH.md Open Questions #3):
   - Length: 3-30 characters
   - Characters: lowercase alphanumeric and hyphens only
   - No leading or trailing hyphens
   - No consecutive hyphens
   - Reserved handles: ["admin", "api", "auth", "signin", "signout", "profile", "settings", "verify-email", "anchor", "www", "mail", "help", "support"]

   ```typescript
   export function validateHandle(handle: string): { valid: boolean; error?: string }
   ```

   **Availability check**:
   ```typescript
   export async function isHandleAvailable(handle: string): Promise<boolean>
   // Query DynamoDB for HANDLE#{handle} key
   ```

   **Claim handle** (per RESEARCH.md Pattern 4 - transaction-based):
   ```typescript
   export async function claimHandle(userId: string, handle: string): Promise<{ success: boolean; error?: string }>
   ```
   - Use TransactWriteCommand with two operations:
     1. Put HANDLE#{handle} item with ConditionExpression "attribute_not_exists(pk)"
     2. Update USER#{userId} to set handle field
   - Handle TransactionCanceledException -> "Handle already taken"
   - Normalize handle to lowercase before all operations

2. Create `app/api/profile/handle/route.ts`:
   - POST handler for claiming handle
   - Verify authenticated (use auth() from @/auth)
   - Validate handle format first (return 400 if invalid)
   - Call claimHandle, return result
   - Return 409 Conflict if handle already taken
   - Return 200 with { handle } on success

3. Create `app/api/profile/route.ts`:
   - GET handler: Return current user profile (handle, displayName, email, spotifyConnected)
   - PATCH handler: Update profile fields (displayName only for now)
   - Both require authentication
   - Update DynamoDB USER#{userId} record

CRITICAL: Use DynamoDB transactions for handle claiming (not application-level check-then-write). This prevents race conditions where two users claim the same handle simultaneously.

AVOID: Don't allow handle changes after initial claim (simplifies v1 - per RESEARCH.md Open Questions #4, can add later with rate limiting).
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Unit test handle validation:
- "test-handle" -> valid
- "Test-Handle" -> valid (normalized to lowercase)
- "ab" -> invalid (too short)
- "admin" -> invalid (reserved)
- "-test" -> invalid (leading hyphen)
  </verify>
  <done>
Handle validation enforces all rules. claimHandle uses DynamoDB transactions for atomic uniqueness. APIs require authentication. Handle claiming returns appropriate errors for invalid/taken handles.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Profile UI and Handle Claiming Flow</name>
  <files>
    app/(protected)/layout.tsx
    app/(protected)/profile/page.tsx
    app/(protected)/profile/claim-handle/page.tsx
    app/components/ProfileForm.tsx
    app/components/HandleInput.tsx
  </files>
  <action>
Create profile management UI:

1. Create `app/(protected)/layout.tsx`:
   - Server component that verifies session
   - Redirect to /signin if not authenticated
   - Simple layout wrapper for protected pages

2. Create `app/components/HandleInput.tsx`:
   - Client component for handle input with real-time validation
   - Show validation errors as user types
   - Debounced availability check (500ms after typing stops)
   - Visual indicators: available (green), taken (red), checking (spinner)
   - Props: value, onChange, disabled, error

3. Create `app/components/ProfileForm.tsx`:
   - Client component for editing display name
   - Controlled form with save button
   - Show loading state during save
   - Show success/error toast after save

4. Create `app/(protected)/profile/claim-handle/page.tsx`:
   - Shown to users who haven't claimed a handle yet
   - HandleInput component for entering desired handle
   - Submit button (disabled until valid + available)
   - On success, redirect to /profile
   - Clean, focused UI - this is an important moment

5. Create `app/(protected)/profile/page.tsx`:
   - Check if user has handle, redirect to /profile/claim-handle if not
   - Display current profile:
     - Handle (read-only after claiming): anchor.band/{handle}
     - Display name (editable via ProfileForm)
     - Email (read-only, from auth)
     - Spotify connection status (connected/not connected)
   - If Spotify not connected, show "Connect Spotify" button
   - Clean, minimal design matching Anchor aesthetic

UI Design notes:
- Use Tailwind for styling
- Calm, minimal aesthetic (no flashy colors)
- Mobile-first responsive design
- Accessible form inputs with labels
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Sign in with any provider
3. Should redirect to /profile/claim-handle (no handle yet)
4. Enter invalid handle -> shows validation error
5. Enter taken handle -> shows "already taken"
6. Enter valid available handle -> can claim
7. After claiming, /profile shows handle and profile info
8. Can edit display name and save
  </verify>
  <done>
Profile page displays user info and allows display name editing. Handle claiming flow validates input and enforces uniqueness. UI follows minimal aesthetic. Spotify connection status visible.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Complete Auth and Profile Flow</name>
  <what-built>
Complete authentication system with three providers (Google, magic link, Spotify OAuth) and profile management with unique handle claiming.
  </what-built>
  <how-to-verify>
**Prerequisites:** Ensure all environment variables are set in .env.local (Google OAuth, Resend API key, Spotify app credentials, AWS credentials, KMS key ID). AWS infrastructure (DynamoDB table, KMS key) must be deployed.

**Test Flow:**

1. **Start fresh:** Clear browser cookies/storage for localhost:3000

2. **Google Sign-In:**
   - Visit http://localhost:3000/signin
   - Click "Continue with Google"
   - Complete Google OAuth flow
   - Expected: Redirected to /profile/claim-handle

3. **Handle Claiming:**
   - Enter a handle (e.g., your name)
   - Verify validation works (try invalid inputs)
   - Claim the handle
   - Expected: Redirected to /profile, shows "anchor.band/{handle}"

4. **Profile Editing:**
   - Edit display name field
   - Click save
   - Refresh page
   - Expected: Display name persists

5. **Spotify Connection:**
   - Click "Connect Spotify" button
   - Complete Spotify OAuth flow
   - Expected: Back on /profile, Spotify shows "Connected"

6. **Sign Out and Back In:**
   - Sign out
   - Sign back in with same Google account
   - Expected: Same profile with handle intact

7. **Magic Link (Optional):**
   - Sign out
   - Enter email on signin page
   - Click "Send Magic Link"
   - Check email, click link
   - Expected: Authenticated, same profile (if same email)

**Check DynamoDB:**
- Verify user record exists with handle
- Verify HANDLE#{handle} record exists
- Verify Spotify tokens are encrypted (not plain text)
  </how-to-verify>
  <resume-signal>Type "approved" if all flows work, or describe any issues encountered</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. TypeScript compiles without errors
2. Handle validation rejects invalid formats
3. Handle claiming uses transactions (check code for TransactWriteCommand)
4. Profile API requires authentication
5. UI allows claiming handle and editing display name
6. Spotify tokens encrypted in DynamoDB
</verification>

<success_criteria>
- Users can claim unique handles with transaction-based uniqueness
- Handle validation enforces all rules (length, characters, reserved words)
- Profile page displays handle, display name, email, Spotify status
- Display name is editable and persists
- Spotify connection works and tokens are KMS-encrypted
- Complete auth flow verified by human
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-03-SUMMARY.md`
</output>
