---
phase: 01-foundation
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - auth.ts
  - app/(protected)/layout.tsx
  - app/components/SignOutButton.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can sign in with Google OAuth after previously using magic link with same email"
    - "User can sign in with Spotify after previously using another provider with same email"
    - "User can see and click a sign out button on any protected page"
    - "Clicking sign out ends session and redirects to home page"
  artifacts:
    - path: "auth.ts"
      provides: "OAuth providers with account linking enabled"
      contains: "allowDangerousEmailAccountLinking: true"
    - path: "app/components/SignOutButton.tsx"
      provides: "Client component for sign out action"
      exports: ["SignOutButton"]
    - path: "app/(protected)/layout.tsx"
      provides: "Protected layout with sign out UI"
      contains: "SignOutButton"
  key_links:
    - from: "app/components/SignOutButton.tsx"
      to: "next-auth/react"
      via: "signOut import"
      pattern: "import.*signOut.*from.*next-auth/react"
    - from: "app/(protected)/layout.tsx"
      to: "app/components/SignOutButton.tsx"
      via: "component import"
      pattern: "import.*SignOutButton"
---

<objective>
Close two UAT gaps from Phase 1 Foundation testing:
1. OAuthAccountNotLinked error when user tries Google OAuth after magic link (blocker)
2. Missing sign out button prevents users from ending sessions (major)

Purpose: Fix authentication flow issues that block real user adoption
Output: Working OAuth account linking and visible sign out functionality
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable OAuth Account Linking</name>
  <files>auth.ts</files>
  <action>
Add `allowDangerousEmailAccountLinking: true` to both Google and Spotify provider configurations in auth.ts.

Current Google provider (lines 15-18):
```typescript
Google({
  clientId: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
}),
```

Update to:
```typescript
Google({
  clientId: process.env.GOOGLE_CLIENT_ID!,
  clientSecret: process.env.GOOGLE_CLIENT_SECRET!,
  allowDangerousEmailAccountLinking: true,
}),
```

Current Spotify provider (lines 23-32):
```typescript
Spotify({
  clientId: process.env.SPOTIFY_CLIENT_ID!,
  clientSecret: process.env.SPOTIFY_CLIENT_SECRET!,
  authorization: {
    url: "https://accounts.spotify.com/authorize",
    params: {
      scope: "user-read-email user-top-read user-read-recently-played",
    },
  },
}),
```

Update to:
```typescript
Spotify({
  clientId: process.env.SPOTIFY_CLIENT_ID!,
  clientSecret: process.env.SPOTIFY_CLIENT_SECRET!,
  allowDangerousEmailAccountLinking: true,
  authorization: {
    url: "https://accounts.spotify.com/authorize",
    params: {
      scope: "user-read-email user-top-read user-read-recently-played",
    },
  },
}),
```

WHY: NextAuth v5 blocks automatic account linking by default as a security measure. When a user signs in with magic link email then tries Google OAuth with the same email, NextAuth rejects it with OAuthAccountNotLinked error. The `allowDangerousEmailAccountLinking` flag tells NextAuth it's safe to link accounts sharing the same verified email address.
  </action>
  <verify>
Grep for `allowDangerousEmailAccountLinking` in auth.ts - should appear twice (Google and Spotify).
TypeScript compilation succeeds: `npx tsc --noEmit`
  </verify>
  <done>
Google and Spotify providers both have allowDangerousEmailAccountLinking: true configured.
Users can sign in with any provider regardless of which provider they used initially, as long as email matches.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add Sign Out Button Component and Layout Integration</name>
  <files>app/components/SignOutButton.tsx, app/(protected)/layout.tsx</files>
  <action>
Create a new client component for the sign out button:

**File: app/components/SignOutButton.tsx**
```typescript
"use client";

import { signOut } from "next-auth/react";

export function SignOutButton() {
  return (
    <button
      onClick={() => signOut({ callbackUrl: "/" })}
      className="text-sm text-gray-600 hover:text-gray-900 transition-colors"
    >
      Sign out
    </button>
  );
}
```

Update the protected layout to include a header with the sign out button:

**File: app/(protected)/layout.tsx**

Current layout just wraps children. Update to include a minimal header with sign out:

```typescript
import { auth } from "@/auth";
import { redirect } from "next/navigation";
import { SignOutButton } from "@/app/components/SignOutButton";

/**
 * Layout for protected routes
 * Verifies authentication and provides sign out access
 */
export default async function ProtectedLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  const session = await auth();

  if (!session) {
    redirect("/signin");
  }

  return (
    <>
      <header className="bg-white border-b border-gray-200">
        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
          <div className="flex justify-between items-center h-14">
            <a href="/dashboard" className="text-lg font-semibold text-gray-900">
              Anchor
            </a>
            <SignOutButton />
          </div>
        </div>
      </header>
      {children}
    </>
  );
}
```

WHY: Sign out functionality exists in auth.ts but was never exposed in the UI. Users need a visible way to end their session. Placing it in the protected layout ensures it appears on ALL protected pages (dashboard, profile, settings) without duplicating code. The header also provides navigation context.
  </action>
  <verify>
1. File exists: `ls app/components/SignOutButton.tsx`
2. Protected layout imports SignOutButton: `grep -n "SignOutButton" app/\(protected\)/layout.tsx`
3. TypeScript compilation succeeds: `npx tsc --noEmit`
4. Dev server runs without errors: `npm run dev` (check for hydration/import errors)
  </verify>
  <done>
SignOutButton component exists and is rendered in protected layout header.
All protected pages show "Anchor" link and "Sign out" button in header.
Clicking sign out calls signOut({ callbackUrl: "/" }) to end session and redirect home.
  </done>
</task>

</tasks>

<verification>
1. OAuth linking: Grep confirms `allowDangerousEmailAccountLinking: true` appears in both Google and Spotify providers
2. Sign out UI: Visit /dashboard or /profile and confirm header with "Sign out" button is visible
3. Sign out works: Click "Sign out" and confirm redirect to home page and session is ended
4. TypeScript: `npx tsc --noEmit` passes with no errors
5. Build: `npm run build` completes successfully
</verification>

<success_criteria>
- Users can sign in with Google OAuth after previously using magic link (OAuthAccountNotLinked error resolved)
- Users can sign in with Spotify after previously using another provider with same email
- Sign out button visible on all protected pages (dashboard, profile)
- Clicking sign out ends session and redirects to home page
- No TypeScript or build errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-04-SUMMARY.md`
</output>
