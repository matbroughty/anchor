---
phase: 01-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - auth.ts
  - app/api/auth/[...nextauth]/route.ts
  - middleware.ts
  - types/next-auth.d.ts
  - lib/spotify.ts
  - app/(auth)/signin/page.tsx
  - app/(auth)/verify-email/page.tsx
  - app/(auth)/layout.tsx
  - app/providers.tsx
  - app/layout.tsx
autonomous: true
user_setup:
  - service: google
    why: "Google OAuth for social login"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client IDs"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials -> Create Credentials"
      - task: "Add authorized redirect URI: http://localhost:3000/api/auth/callback/google"
        location: "Google Cloud Console -> OAuth client settings -> Authorized redirect URIs"
  - service: resend
    why: "Magic link email delivery"
    env_vars:
      - name: AUTH_RESEND_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify domain or use Resend test domain for development"
        location: "Resend Dashboard -> Domains"
  - service: spotify
    why: "Spotify OAuth for music data access"
    env_vars:
      - name: SPOTIFY_CLIENT_ID
        source: "Spotify Developer Dashboard -> App Settings -> Client ID"
      - name: SPOTIFY_CLIENT_SECRET
        source: "Spotify Developer Dashboard -> App Settings -> Client secret"
    dashboard_config:
      - task: "Create Spotify App"
        location: "Spotify Developer Dashboard -> Create app"
      - task: "Add redirect URI: http://localhost:3000/api/auth/callback/spotify"
        location: "Spotify Developer Dashboard -> App Settings -> Redirect URIs"

must_haves:
  truths:
    - "User can sign in with Google and see their session"
    - "User can request magic link email and authenticate via link"
    - "User can connect Spotify and tokens are encrypted before storage"
    - "Unauthenticated users are redirected from protected routes"
  artifacts:
    - path: "auth.ts"
      provides: "NextAuth v5 configuration"
      exports: ["handlers", "auth", "signIn", "signOut"]
    - path: "app/api/auth/[...nextauth]/route.ts"
      provides: "Auth API route handler"
      exports: ["GET", "POST"]
    - path: "middleware.ts"
      provides: "Route protection"
      contains: "export default auth"
    - path: "lib/spotify.ts"
      provides: "Spotify token refresh and storage"
      exports: ["refreshSpotifyToken", "storeSpotifyTokens"]
    - path: "types/next-auth.d.ts"
      provides: "Custom type augmentation"
      contains: "declare module"
  key_links:
    - from: "auth.ts"
      to: "lib/dynamodb.ts"
      via: "DynamoDBAdapter import"
      pattern: "DynamoDBAdapter\\(.*dynamoClient"
    - from: "auth.ts"
      to: "lib/kms.ts"
      via: "Token encryption in account callback"
      pattern: "encryptToken"
    - from: "lib/spotify.ts"
      to: "accounts.spotify.com/api/token"
      via: "fetch for token refresh"
      pattern: "accounts\\.spotify\\.com/api/token"
    - from: "middleware.ts"
      to: "auth.ts"
      via: "auth import for route protection"
      pattern: 'import.*auth.*from.*"@/auth"'
---

<objective>
Implement complete NextAuth v5 authentication with Google, magic link email, and Spotify OAuth providers.

Purpose: Enable users to authenticate via multiple methods and securely connect their Spotify accounts with KMS-encrypted token storage. This is the core authentication system that all other features depend on.

Output: Working authentication flow with all three providers, encrypted Spotify token storage, and protected route middleware.
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
@.planning/phases/01-foundation/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure NextAuth v5 Core with All Providers</name>
  <files>
    auth.ts
    app/api/auth/[...nextauth]/route.ts
    types/next-auth.d.ts
    lib/spotify.ts
  </files>
  <action>
Create NextAuth v5 configuration with DynamoDB adapter and all three providers:

1. Create `types/next-auth.d.ts` for custom field augmentation:
   ```typescript
   import "next-auth"
   import "next-auth/jwt"

   declare module "next-auth" {
     interface User {
       id: string
       handle?: string
       displayName?: string
       spotifyConnected?: boolean
     }
     interface Session {
       user: User
     }
   }

   declare module "next-auth/jwt" {
     interface JWT {
       handle?: string
       spotifyAccessToken?: string
       spotifyRefreshToken?: string
       spotifyTokenExpires?: number
     }
   }
   ```

2. Create `lib/spotify.ts` with token refresh logic:
   - `refreshSpotifyToken(token: JWT)` function per RESEARCH.md Pattern 2
   - Check expiration BEFORE refreshing (50-minute threshold, not 60)
   - Return error token on failure, don't throw
   - `storeSpotifyTokens(userId, accessToken, refreshToken)` using KMS encryption
   - `getSpotifyTokens(userId)` with KMS decryption

3. Create `auth.ts` at project root:
   - Import DynamoDBAdapter from @auth/dynamodb-adapter
   - Use dynamoClient from lib/dynamodb.ts
   - Configure database session strategy (required for magic links)
   - Add Google provider with clientId/clientSecret from env
   - Add Resend provider with from: "noreply@anchor.band"
   - Add Spotify provider with scopes: "user-read-email user-top-read user-read-recently-played"
   - Implement callbacks:
     - `signIn`: On Spotify sign-in, encrypt and store tokens
     - `session`: Add custom fields (handle, spotifyConnected) to session
   - Configure custom pages: signIn: "/signin", verifyRequest: "/verify-email"
   - Export { handlers, auth, signIn, signOut }

4. Create `app/api/auth/[...nextauth]/route.ts`:
   ```typescript
   import { handlers } from "@/auth"
   export const { GET, POST } = handlers
   ```

CRITICAL (from RESEARCH.md pitfalls):
- Use `AUTH_*` env var prefix, not `NEXTAUTH_*`
- Use database session strategy (JWT won't work with magic links)
- Check token expiration BEFORE refreshing Spotify tokens (avoid race conditions)
- Encryption context must match exactly between encrypt/decrypt

AVOID: Don't use JWT session strategy. Don't refresh Spotify token on every callback invocation. Don't store plain-text tokens.
  </action>
  <verify>
TypeScript compiles: `npx tsc --noEmit`
Auth config exports correctly: Check that auth.ts exports handlers, auth, signIn, signOut
  </verify>
  <done>
NextAuth v5 configured with DynamoDB adapter, database sessions, and all three providers (Google, Resend, Spotify). Spotify tokens are encrypted with KMS before storage. Custom types augment User and Session.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Auth UI Pages and Middleware</name>
  <files>
    middleware.ts
    app/providers.tsx
    app/layout.tsx
    app/(auth)/layout.tsx
    app/(auth)/signin/page.tsx
    app/(auth)/verify-email/page.tsx
  </files>
  <action>
Create authentication UI and route protection:

1. Create `middleware.ts` at project root (per RESEARCH.md Pattern 5):
   ```typescript
   import { auth } from "@/auth"
   import { NextResponse } from "next/server"

   export default auth((req) => {
     const isLoggedIn = !!req.auth
     const isProtected = req.nextUrl.pathname.startsWith("/profile") ||
                         req.nextUrl.pathname.startsWith("/settings")
     const isAuthPage = req.nextUrl.pathname.startsWith("/signin") ||
                        req.nextUrl.pathname.startsWith("/verify-email")

     // Redirect to signin if accessing protected route while logged out
     if (isProtected && !isLoggedIn) {
       return NextResponse.redirect(new URL("/signin", req.url))
     }

     // Redirect to profile if accessing auth pages while logged in
     if (isAuthPage && isLoggedIn) {
       return NextResponse.redirect(new URL("/profile", req.url))
     }

     return NextResponse.next()
   })

   export const config = {
     matcher: ["/((?!api|_next/static|_next/image|favicon.ico).*)"],
   }
   ```

2. Create `app/providers.tsx` for SessionProvider:
   ```typescript
   "use client"
   import { SessionProvider } from "next-auth/react"

   export function Providers({ children }: { children: React.ReactNode }) {
     return <SessionProvider>{children}</SessionProvider>
   }
   ```

3. Update `app/layout.tsx` to wrap with Providers

4. Create `app/(auth)/layout.tsx` - minimal layout for auth pages (centered content)

5. Create `app/(auth)/signin/page.tsx`:
   - Server component that checks session (redirect if logged in)
   - Display sign-in options:
     - "Continue with Google" button -> signIn("google")
     - Email input + "Send Magic Link" button -> signIn("resend", { email })
     - "Connect Spotify" button -> signIn("spotify") (for linking, not primary auth)
   - Use next-auth/react signIn function
   - Clean, minimal styling with Tailwind (matches Anchor aesthetic)

6. Create `app/(auth)/verify-email/page.tsx`:
   - Simple page shown after magic link email sent
   - Message: "Check your email for a sign-in link"
   - Link back to signin page

AVOID: Don't implement auth checks in layout components (they don't re-render on navigation - RESEARCH.md anti-pattern). Use middleware for route protection.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Visit http://localhost:3000/signin - shows sign-in options
3. Visit http://localhost:3000/profile - redirects to /signin (not authenticated)
4. Visit http://localhost:3000/verify-email - shows verification message
  </verify>
  <done>
Sign-in page displays all three auth options. Verify-email page shows confirmation message. Middleware protects /profile and /settings routes. Authenticated users are redirected away from auth pages.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npx tsc --noEmit` passes with no type errors
2. `npm run dev` starts without errors
3. /signin page renders with Google, Email, and Spotify options
4. /profile redirects to /signin when not authenticated
5. auth.ts exports handlers, auth, signIn, signOut
6. Spotify token storage uses KMS encryption (verify in code)
</verification>

<success_criteria>
- NextAuth v5 configured with database session strategy
- Google OAuth provider working (can initiate flow)
- Resend magic link provider configured
- Spotify OAuth with encrypted token storage
- Custom sign-in and verify-email pages
- Middleware protects /profile and /settings routes
- Session includes custom fields (handle, spotifyConnected)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-02-SUMMARY.md`
</output>
