---
phase: 01-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - next.config.ts
  - tsconfig.json
  - app/layout.tsx
  - app/page.tsx
  - lib/dynamodb.ts
  - lib/kms.ts
  - infrastructure/dynamodb-table.json
  - infrastructure/kms-key.json
  - .env.example
autonomous: true
user_setup:
  - service: aws
    why: "DynamoDB table and KMS key for authentication storage and token encryption"
    env_vars:
      - name: AUTH_DYNAMODB_ID
        source: "AWS IAM -> Users -> Create user -> Security credentials -> Access keys"
      - name: AUTH_DYNAMODB_SECRET
        source: "AWS IAM -> Users -> Create user -> Security credentials -> Access keys"
      - name: AUTH_DYNAMODB_REGION
        source: "Region where DynamoDB table is created (e.g., us-east-1)"
      - name: KMS_KEY_ID
        source: "AWS KMS -> Customer managed keys -> Create key -> Key ID (after running CloudFormation)"
    dashboard_config:
      - task: "Create IAM user with DynamoDB and KMS permissions"
        location: "AWS IAM Console -> Users -> Add user"
      - task: "Deploy DynamoDB table using provided CloudFormation template"
        location: "AWS CloudFormation -> Create stack -> Upload infrastructure/dynamodb-table.json"
      - task: "Deploy KMS key using provided CloudFormation template"
        location: "AWS CloudFormation -> Create stack -> Upload infrastructure/kms-key.json"

must_haves:
  truths:
    - "Next.js 15 app runs locally with npm run dev"
    - "DynamoDB table exists with pk/sk/GSI1 schema"
    - "KMS key exists and can encrypt/decrypt test data"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next-auth"
    - path: "lib/dynamodb.ts"
      provides: "DynamoDB document client"
      exports: ["dynamoClient"]
    - path: "lib/kms.ts"
      provides: "Token encryption utilities"
      exports: ["encryptToken", "decryptToken"]
    - path: "infrastructure/dynamodb-table.json"
      provides: "CloudFormation template for DynamoDB"
      contains: "AWS::DynamoDB::Table"
    - path: "infrastructure/kms-key.json"
      provides: "CloudFormation template for KMS"
      contains: "AWS::KMS::Key"
  key_links:
    - from: "lib/dynamodb.ts"
      to: "@aws-sdk/lib-dynamodb"
      via: "DynamoDBDocumentClient import"
      pattern: "DynamoDBDocumentClient"
    - from: "lib/kms.ts"
      to: "@aws-sdk/client-kms"
      via: "KMSClient import"
      pattern: "KMSClient"
---

<objective>
Set up Next.js 15 project with AWS infrastructure for authentication foundation.

Purpose: Create the foundational infrastructure that all authentication features depend on - the Next.js application, DynamoDB table for session/user storage, and KMS key for Spotify token encryption.

Output: Running Next.js 15 app with DynamoDB and KMS client utilities ready for NextAuth integration.
</objective>

<execution_context>
@/Users/mathewbroughton/.claude/get-shit-done/workflows/execute-plan.md
@/Users/mathewbroughton/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Next.js 15 Project</name>
  <files>
    package.json
    next.config.ts
    tsconfig.json
    app/layout.tsx
    app/page.tsx
    app/globals.css
    .env.example
    .gitignore
  </files>
  <action>
Create Next.js 15 project with App Router using create-next-app or manual setup:

1. Initialize with: `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir=false --import-alias="@/*"`
   - If directory has files, use `--yes` to overwrite or manually create files

2. Install authentication and AWS dependencies:
   ```bash
   npm install next-auth@beta @auth/dynamodb-adapter @aws-sdk/client-kms @aws-sdk/client-dynamodb @aws-sdk/lib-dynamodb
   ```

3. Create `.env.example` with all required variables (DO NOT include actual values):
   ```
   # Auth.js
   AUTH_SECRET=
   AUTH_URL=http://localhost:3000

   # AWS DynamoDB
   AUTH_DYNAMODB_ID=
   AUTH_DYNAMODB_SECRET=
   AUTH_DYNAMODB_REGION=

   # AWS KMS
   KMS_KEY_ID=

   # Google OAuth (for Plan 02)
   GOOGLE_CLIENT_ID=
   GOOGLE_CLIENT_SECRET=

   # Resend (for Plan 02)
   AUTH_RESEND_KEY=

   # Spotify (for Plan 02)
   SPOTIFY_CLIENT_ID=
   SPOTIFY_CLIENT_SECRET=
   ```

4. Update `.gitignore` to include `.env.local` and `.env` (not `.env.example`)

5. Create minimal app/layout.tsx with SessionProvider wrapper placeholder (will be implemented in Plan 02)

6. Create minimal app/page.tsx with "Anchor.band" heading and placeholder content

AVOID: Don't use `pages/` directory (App Router only). Don't install Prisma or other ORMs (using DynamoDB directly).
  </action>
  <verify>
Run `npm run dev` - app starts on localhost:3000 without errors.
Run `npm ls next-auth @aws-sdk/client-kms` - dependencies installed.
  </verify>
  <done>
Next.js 15 app runs locally. All dependencies from RESEARCH.md standard stack are installed. .env.example documents all required environment variables.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AWS Infrastructure Templates</name>
  <files>
    infrastructure/dynamodb-table.json
    infrastructure/kms-key.json
    infrastructure/README.md
  </files>
  <action>
Create CloudFormation templates for AWS resources:

1. Create `infrastructure/dynamodb-table.json` CloudFormation template:
   - Table name parameter (default: "anchor-auth")
   - Partition key: `pk` (String)
   - Sort key: `sk` (String)
   - GSI named `GSI1` with partition key `GSI1PK` (String) and sort key `GSI1SK` (String)
   - TTL enabled on `expires` attribute
   - On-demand billing mode (pay-per-request, no provisioned capacity)
   - Point-in-time recovery enabled

2. Create `infrastructure/kms-key.json` CloudFormation template:
   - Symmetric key for encrypt/decrypt
   - Key alias: "alias/anchor-spotify-tokens"
   - Key policy allowing the deploying IAM user/role full access
   - Enable key rotation
   - Description: "Encryption key for Anchor.band Spotify OAuth tokens"

3. Create `infrastructure/README.md` with deployment instructions:
   - Prerequisites (AWS CLI configured, IAM permissions)
   - Deploy commands for both templates
   - How to retrieve outputs (table name, key ID)
   - IAM policy needed for the application

DynamoDB schema follows Auth.js adapter requirements from RESEARCH.md:
- pk/sk as composite primary key
- GSI1 with GSI1PK/GSI1SK for user lookups
- expires TTL for automatic session cleanup
  </action>
  <verify>
Validate templates with AWS CLI:
```bash
aws cloudformation validate-template --template-body file://infrastructure/dynamodb-table.json
aws cloudformation validate-template --template-body file://infrastructure/kms-key.json
```
  </verify>
  <done>
CloudFormation templates are valid and ready for deployment. README explains deployment process. Templates follow DynamoDB adapter schema requirements from research.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create DynamoDB and KMS Client Utilities</name>
  <files>
    lib/dynamodb.ts
    lib/kms.ts
    types/env.d.ts
  </files>
  <action>
Create typed client utilities for AWS services:

1. Create `types/env.d.ts` for environment variable types:
   ```typescript
   declare namespace NodeJS {
     interface ProcessEnv {
       AUTH_DYNAMODB_ID: string
       AUTH_DYNAMODB_SECRET: string
       AUTH_DYNAMODB_REGION: string
       KMS_KEY_ID: string
       AUTH_SECRET: string
       // Add others as needed
     }
   }
   ```

2. Create `lib/dynamodb.ts`:
   - Create DynamoDB client with credentials from AUTH_DYNAMODB_* env vars
   - Create DynamoDBDocument client with marshalling options (per RESEARCH.md Pattern 1):
     - convertEmptyValues: true
     - removeUndefinedValues: true
     - convertClassInstanceToMap: true
   - Export both raw client and document client
   - Export table name constant

3. Create `lib/kms.ts`:
   - Create KMSClient with region from AUTH_DYNAMODB_REGION
   - Implement `encryptToken(plaintext: string): Promise<string>`
     - Uses EncryptCommand with KMS_KEY_ID
     - Encryption context: { purpose: "spotify-token", app: "anchor" }
     - Returns base64-encoded ciphertext
   - Implement `decryptToken(ciphertext: string): Promise<string>`
     - Uses DecryptCommand with same encryption context
     - Returns decrypted plaintext string
   - Handle errors gracefully with typed error responses

CRITICAL: Encryption context MUST match exactly between encrypt and decrypt (per RESEARCH.md Pitfall 5). Use constants, not inline strings.

AVOID: Don't hardcode credentials. Don't use AWS SDK v2 patterns. Don't skip encryption context.
  </action>
  <verify>
TypeScript compiles without errors:
```bash
npx tsc --noEmit
```

Manual verification (after user deploys infrastructure):
- Create test script that encrypts "test-token" and decrypts it back
- Verify round-trip works with actual KMS key
  </verify>
  <done>
DynamoDB document client configured per Auth.js adapter requirements. KMS utilities implement encrypt/decrypt with proper encryption context. TypeScript types enforce environment variables.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run dev` starts Next.js on localhost:3000
2. `npm ls` shows all dependencies from research installed
3. `npx tsc --noEmit` passes with no type errors
4. CloudFormation templates validate successfully
5. lib/dynamodb.ts exports dynamoClient
6. lib/kms.ts exports encryptToken and decryptToken functions
</verification>

<success_criteria>
- Next.js 15 app scaffolded with App Router structure
- All AWS SDK v3 packages and next-auth@beta installed
- CloudFormation templates ready for DynamoDB table (with GSI1) and KMS key
- DynamoDB document client configured with Auth.js adapter marshalling options
- KMS encryption utilities with consistent encryption context
- Environment variable documentation complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation/01-01-SUMMARY.md`
</output>
